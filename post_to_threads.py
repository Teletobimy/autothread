"""
âœ¨ í”¼ë”ë¦° (PYDERIN): í”¼ë¶€ ê³¼í•™ ê¸°ë°˜ PDRN ì „ë¬¸ ë”ë§ˆ ì†”ë£¨ì…˜

1. ë¸Œëœë“œ ê°œìš” ë° ë¯¸ì…˜

í•­ëª©ë‚´ìš©ë¸Œëœë“œëª…PYDERIN (í”¼ë”ë¦°)ë¸Œëœë“œ ì •ì²´ì„±í”¼ë¶€ ë³¸ì—°ì˜ ê±´ê°•í•œ íšŒë³µì— ì§‘ì¤‘í•˜ëŠ” PDRN ì „ë¬¸ ë”ë§ˆ ì½”ìŠ¤ë©”í‹± ë¸Œëœë“œ (Neo-Regeneration)í•µì‹¬ ë¯¸ì…˜ì˜ë£Œ ì „ë¬¸ì„±ê³¼ ì„±ë¶„ íˆ¬ëª…ì„±ì„ ê¸°ë°˜ìœ¼ë¡œ, ì¶•ì ëœ í”¼ë¶€ ê³¼í•™ ê¸°ìˆ ë ¥ì„ ì¼ìƒ ì† í”¼ë¶€ ì¼€ì–´ë¡œ ì—°ê²°í•˜ì—¬ ê±´ê°•í•œ ì•„ë¦„ë‹¤ì›€ì„ ì™„ì„±í•©ë‹ˆë‹¤.2. í”¼ë”ë¦°ì˜ ì°¨ë³„í™”ëœ í•µì‹¬ ê°€ì¹˜ (The Core Value)

í”¼ë”ë¦°ì€ ë‹¨ìˆœí•œ í™”ì¥í’ˆì„ ë„˜ì–´, **'ê³¼í•™ì ìœ¼ë¡œ ê²€ì¦ëœ í”¼ë¶€ íšŒë³µ ì†”ë£¨ì…˜'**ì„ ì œê³µí•©ë‹ˆë‹¤.

ğŸ¥‡ ê³ ìˆœë„ PDRN (í•µì‹¬ ì„±ë¶„)

ì„±ë¶„ íˆ¬ëª…ì„±: ëŒ€í•œë¯¼êµ­ ì²œì—°ì–´ì—ì„œ ì—„ì„ í•˜ì—¬ ì¶”ì¶œí•œ 99% ê³ ìˆœë„ PDRNë§Œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

PDRNì˜ ì—­í• : í”¼ë¶€ì— ìƒˆë¡œìš´ ìƒëª… ì—ë„ˆì§€ë¥¼ ë¶ˆì–´ë„£ì–´ í”¼ë¶€ ì¬ìƒì˜ ë³¸ì§ˆì— ì§‘ì¤‘í•˜ê³ , ì†ìƒëœ í”¼ë¶€ì˜ ê±´ê°•í•œ íšŒë³µì„ ë•ìŠµë‹ˆë‹¤.

ğŸ”¬ ì´ˆì €ë¶„ì ê³¼í•™ ê¸°ìˆ  (ì „ë‹¬ë ¥)

97kDa ì´ˆì €ë¶„ì ê¸°ìˆ : ìœ íš¨ ì„±ë¶„ì¸ PDRNì„ í”¼ë¶€ ê¹Šì€ ê³³ê¹Œì§€ íš¨ìœ¨ì ìœ¼ë¡œ ì „ë‹¬í•˜ê¸° ìœ„í•´ ì´ˆì €ë¶„ìí™” ê¸°ìˆ ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.

ìµœì ì˜ í¡ìˆ˜: í”¼ë¶€ ì»¨ë””ì…˜ì„ ê· í˜• ìˆê²Œ ê´€ë¦¬í•˜ê³ , ì„±ë¶„ì˜ íš¨ëŠ¥ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.

ğŸ§‘â€âš•ï¸ ì˜ë£Œ ê¸°ë°˜ ì†”ë£¨ì…˜ (ì‹ ë¢°ì„±)

ê²€ì¦ëœ ë°ì´í„°: êµ­ë‚´ì™¸ ìš°ìˆ˜ ì—°êµ¬ê¸°ê´€ê³¼ í˜‘ë ¥í•˜ì—¬ ê²€ì¦ëœ ì„ìƒ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œí’ˆì„ ê°œë°œí•©ë‹ˆë‹¤.

ì „ë¬¸ì„±: ì˜ë£Œ í˜„ì¥ì—ì„œ ì•ˆì •ì„±ê³¼ íšŒë³µë ¥ì´ ê²€ì¦ëœ ê¸°ìˆ ë ¥ì„ ë°”íƒ•ìœ¼ë¡œ, ì¼ìƒì—ì„œë„ ì „ë¬¸ì ì¸ ë”ë§ˆ ì†”ë£¨ì…˜ì„ ê²½í—˜í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

3. ì£¼ìš” ì œí’ˆ ë¼ì¸ì—… (ì˜ˆì‹œ)

í”¼ë”ë¦°ì€ ì „ë¬¸ì ì¸ ê¸°ìˆ ë ¥ì„ ë‹´ì•„ í”¼ë¶€ ê³ ë¯¼ë³„ ìµœì í™”ëœ í† íƒˆ ìŠ¤í‚¨ì¼€ì–´ ë¼ì¸ì„ ì œê³µí•©ë‹ˆë‹¤.

Hospital Line: ì˜ë£Œ í˜„ì¥ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì „ë¬¸ ì œí’ˆêµ° (ë³‘ì› ì „ìš©)

Daily Care Line: ì¼ìƒ ì† í”¼ë¶€ ì»¨ë””ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ë°ì¼ë¦¬ ì†”ë£¨ì…˜

PDRN íƒ„ë ¥ í• ì•°í”Œ: ê³ ìˆœë„ PDRNì„ ë‹´ì•„ ì§‘ì¤‘ì ì¸ íƒ„ë ¥ ë° ì¬ìƒ ê´€ë¦¬ë¥¼ ë•ëŠ” í•µì‹¬ ì œí’ˆ.

PDRN íƒ„ë ¥ í¬ë¦¼: í”¼ë¶€ ì¥ë²½ ê°•í™” ë° íƒ„ë ¥ ìœ ì§€ì— ë„ì›€ì„ ì£¼ëŠ” ê³ ë³´ìŠµ í¬ë¦¼.

PDRN ë§ˆìŠ¤í¬íŒ©: ì§‘ì¤‘ì ì¸ ì˜ì–‘ ê³µê¸‰ ë° í”¼ë¶€ íšŒë³µì„ ìœ„í•œ ë§ˆìŠ¤í¬íŒ© (ì†/ë°œ ë§ˆìŠ¤í¬íŒ© í¬í•¨).

PDRN í´ë Œì§•: ìˆœí•˜ë©´ì„œë„ íš¨ê³¼ì ì¸ ì„¸ì •ì„ ë•ëŠ” ê±°í’ˆ í´ë Œì €.



ì´ ë¶€ë¶„ì„ AI AX ì „ë¬¸ê°€ë¡œ ë°”ê¿€ê±´ë° ë‹¤ì‹œ ì˜ í”„ë¡¬í”„íŠ¸ë¡œ ì“¸ ìˆ˜ ìˆê²Œ ì •ë¦¬í•´ì„œ ë‚˜í•œí…Œ ì•Œë ¤ì¤˜



ì£¼ì œ => AI AX ì „ë¬¸ê°€ ê¸°ì¤€ì—ì„œì˜ ê´€ì :

ë°°ê²½ : K-ë·°í‹° ë¸Œëœë“œì—ì„œ íšŒì‚¬ ë‚´ë¶€ ì—…ë¬´ë¥¼ ê°•ë ¥í•˜ê²Œ AX ì¶”ì§„ ì¤‘ì¸ ìƒí™©

1) ì§€ê¸ˆê¹Œì§€ ì§„í–‰ ì™„ë£Œ
 - 


"""


import os, json, requests
import sys
from dotenv import load_dotenv
from openai import OpenAI

# Windows ì½˜ì†” UTF-8 ì¸ì½”ë”© ì„¤ì •
if sys.platform == 'win32':
    try:
        sys.stdout.reconfigure(encoding='utf-8')
        sys.stderr.reconfigure(encoding='utf-8')
    except AttributeError:
        # Python 3.6 ì´í•˜ ë²„ì „ì„ ìœ„í•œ ëŒ€ì²´ ë°©ë²•
        import codecs
        sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
        sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'strict')

# .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

BASE = "https://graph.threads.net/v1.0"

def get_token():
    """í™˜ê²½ ë³€ìˆ˜ì—ì„œ í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    token = os.getenv('LONG_LIVED_ACCESS_TOKEN')
    if not token:
        raise ValueError("LONG_LIVED_ACCESS_TOKENì´ .env íŒŒì¼ì— ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    return token.strip().strip('"').strip("'")  # ë”°ì˜´í‘œ ì œê±°

def generate_text_with_gpt(topic=None, style="engaging", max_length=500):
    """
    GPTë¥¼ ì‚¬ìš©í•˜ì—¬ Threadsìš© í…ìŠ¤íŠ¸ ì½˜í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        topic (str, optional): ìƒì„±í•  ì½˜í…ì¸ ì˜ ì£¼ì œ. Noneì´ë©´ ìë™ ìƒì„±
        style (str): ì½˜í…ì¸  ìŠ¤íƒ€ì¼ (ê¸°ë³¸ê°’: "engaging")
        max_length (int): ìµœëŒ€ ë¬¸ì ê¸¸ì´ (ê¸°ë³¸ê°’: 500)
    
    Returns:
        str: ìƒì„±ëœ Threads í…ìŠ¤íŠ¸ ì½˜í…ì¸ 
    """
    # í™˜ê²½ ë³€ìˆ˜ì—ì„œ OpenAI API í‚¤ ë¡œë“œ
    api_key = os.getenv('OPENAI_API_KEY')
    model = 'gpt-4o'  # gpt-5ëŠ” ì•„ì§ ì¶œì‹œë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ gpt-4o ì‚¬ìš©
    
    if not api_key:
        raise ValueError("OPENAI_API_KEYê°€ .env íŒŒì¼ì— ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    
    # OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    client = OpenAI(api_key=api_key.strip().strip('"').strip("'"))
    
    # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    if topic:
        prompt = f"""Threadsì— ê²Œì‹œí•  {style}í•œ í…ìŠ¤íŠ¸ ì½˜í…ì¸ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì£¼ì œ: {topic}

ìš”êµ¬ì‚¬í•­:
- Threads í”Œë«í¼ì— ì í•©í•œ ê°„ê²°í•˜ê³  ë§¤ë ¥ì ì¸ ì½˜í…ì¸ 
- ìµœëŒ€ {max_length}ì ì´ë‚´
- ìì—°ìŠ¤ëŸ½ê³  ì½ê¸° ì‰¬ìš´ ë¬¸ì²´
- í•µì‹¬ ë©”ì‹œì§€ê°€ ëª…í™•í•˜ê²Œ ì „ë‹¬ë˜ë„ë¡ ì‘ì„±

í…ìŠ¤íŠ¸ë§Œ ì‘ì„±í•˜ê³ , ë”°ì˜´í‘œë‚˜ ì„¤ëª… ì—†ì´ ì½˜í…ì¸ ë§Œ ë°˜í™˜í•´ì£¼ì„¸ìš”."""
    else:
        prompt = f"""Threadsì— ê²Œì‹œí•  {style}í•œ í…ìŠ¤íŠ¸ ì½˜í…ì¸ ë¥¼ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.

ìš”êµ¬ì‚¬í•­:
- Threads í”Œë«í¼ì— ì í•©í•œ ê°„ê²°í•˜ê³  ë§¤ë ¥ì ì¸ ì½˜í…ì¸ 
- ìµœëŒ€ {max_length}ì ì´ë‚´
- ìì—°ìŠ¤ëŸ½ê³  ì½ê¸° ì‰¬ìš´ ë¬¸ì²´
- í¥ë¯¸ë¡­ê³  ì°¸ì—¬ë¥¼ ìœ ë„í•˜ëŠ” ë‚´ìš©

í…ìŠ¤íŠ¸ë§Œ ì‘ì„±í•˜ê³ , ë”°ì˜´í‘œë‚˜ ì„¤ëª… ì—†ì´ ì½˜í…ì¸ ë§Œ ë°˜í™˜í•´ì£¼ì„¸ìš”."""
    
    try:
        # GPT API í˜¸ì¶œ
        response = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": "You are a creative content writer specializing in social media posts for Threads platform."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=200
        )
        
        # ìƒì„±ëœ ì½˜í…ì¸  ì¶”ì¶œ
        content = response.choices[0].message.content.strip()
        
        # ë”°ì˜´í‘œ ì œê±° (ìˆëŠ” ê²½ìš°)
        if content.startswith('"') and content.endswith('"'):
            content = content[1:-1]
        elif content.startswith("'") and content.endswith("'"):
            content = content[1:-1]
        
        print(f"âœ… GPT ì½˜í…ì¸  ìƒì„± ì™„ë£Œ ({len(content)}ì)")
        return content
        
    except Exception as e:
        print(f"âŒ GPT ì½˜í…ì¸  ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        raise

def me(token=None):
    if token is None:
        token = get_token()
    r = requests.get(f"{BASE}/me", params={"fields":"id,username","access_token":token}, timeout=20)
    r.raise_for_status()
    return r.json()

def create_text_container(threads_user_id, text, token=None):
    if token is None:
        token = get_token()
    payload = {"media_type":"TEXT", "text": text, "access_token": token}
    r = requests.post(f"{BASE}/{threads_user_id}/threads",
                      headers={"Content-Type":"application/json"},
                      data=json.dumps(payload), timeout=30)
    r.raise_for_status()
    return r.json()["id"]  # creation_id

def publish_container(threads_user_id, creation_id, token=None):
    if token is None:
        token = get_token()
    r = requests.post(f"{BASE}/{threads_user_id}/threads_publish",
                      data={"creation_id": creation_id, "access_token": token}, timeout=20)
    r.raise_for_status()
    return r.json()["id"]  # ìµœì¢… media id

def get_permalink(media_id, token=None):
    if token is None:
        token = get_token()
    r = requests.get(f"{BASE}/{media_id}", params={"fields":"permalink","access_token":token}, timeout=20)
    r.raise_for_status()
    return r.json()["permalink"]

def post_gpt_generated_text(topic=None, style="engaging", max_length=500, token=None):
    """
    GPTë¡œ í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ê³  Threadsì— ê²Œì‹œí•˜ëŠ” ì „ì²´ í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    
    Args:
        topic (str, optional): GPTê°€ ìƒì„±í•  ì½˜í…ì¸ ì˜ ì£¼ì œ
        style (str): ì½˜í…ì¸  ìŠ¤íƒ€ì¼
        max_length (int): ìµœëŒ€ ë¬¸ì ê¸¸ì´
        token (str, optional): Threads ì•¡ì„¸ìŠ¤ í† í° (Noneì´ë©´ .envì—ì„œ ì½ìŒ)
    
    Returns:
        dict: ê²Œì‹œ ê²°ê³¼ (media_id, permalink ë“± í¬í•¨)
    """
    # 1ë‹¨ê³„: GPTë¡œ í…ìŠ¤íŠ¸ ìƒì„±
    print("ğŸ¤– GPTë¡œ í…ìŠ¤íŠ¸ ìƒì„± ì¤‘...")
    text = generate_text_with_gpt(topic=topic, style=style, max_length=max_length)
    print(f"ìƒì„±ëœ í…ìŠ¤íŠ¸: {text[:100]}...")
    
    # 2ë‹¨ê³„: Threads ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    if token is None:
        token = get_token()
    print("ğŸ“‹ Threads ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì¤‘...")
    user_info = me(token=token)
    threads_user_id = user_info["id"]
    print(f"ì‚¬ìš©ì ID: {threads_user_id} (@{user_info.get('username', 'N/A')})")
    
    # 3ë‹¨ê³„: ì»¨í…Œì´ë„ˆ ìƒì„±
    print("ğŸ“¦ ì»¨í…Œì´ë„ˆ ìƒì„± ì¤‘...")
    creation_id = create_text_container(threads_user_id, text, token=token)
    
    # 4ë‹¨ê³„: ê²Œì‹œ
    print("ğŸš€ Threadsì— ê²Œì‹œ ì¤‘...")
    media_id = publish_container(threads_user_id, creation_id, token=token)
    
    # 5ë‹¨ê³„: Permalink ê°€ì ¸ì˜¤ê¸°
    print("ğŸ”— Permalink ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
    permalink = get_permalink(media_id, token=token)
    
    result = {
        "media_id": media_id,
        "creation_id": creation_id,
        "permalink": permalink,
        "text": text,
        "user_id": threads_user_id
    }
    
    print(f"\nâœ… ê²Œì‹œ ì™„ë£Œ!")
    print(f"ğŸ“ Media ID: {media_id}")
    print(f"ğŸ”— Permalink: {permalink}")
    
    return result

if __name__ == "__main__":
    import sys
    
    # ëª…ë ¹ì¤„ ì¸ì ì²˜ë¦¬
    if len(sys.argv) > 1:
        # ì£¼ì œê°€ ì œê³µëœ ê²½ìš° GPTë¡œ ìƒì„±í•´ì„œ ê²Œì‹œ
        topic = sys.argv[1]
        print(f"ğŸ¯ ì£¼ì œ: {topic}")
        print("=" * 60)
        result = post_gpt_generated_text(topic=topic)
    else:
        # ê¸°ë³¸ í…ŒìŠ¤íŠ¸: ìˆ˜ë™ í…ìŠ¤íŠ¸ë¡œ ê²Œì‹œ
        print("=" * 60)
        print("ğŸ“ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ìˆ˜ë™ í…ìŠ¤íŠ¸)")
        print("=" * 60)
        m = me()
        uid = m["id"]
        print("âœ… me:", m)

        creation_id = create_text_container(uid, "Hello from API âœ¨")
        print("ğŸ§© creation_id:", creation_id)

        media_id = publish_container(uid, creation_id)
        print("ğŸš€ published media_id:", media_id)

        link = get_permalink(media_id)
        print("ğŸ”— permalink:", link)
        
        print("\nğŸ’¡ GPTë¡œ ìƒì„±í•˜ë ¤ë©´: python post_to_threads.py \"ì£¼ì œ\"")
